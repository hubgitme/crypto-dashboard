<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù‚ÛŒÙ…Øª + Ø¢Ù†â€ŒÚ†ÛŒÙ† Node.js</title>
<style>
body{font-family:Tahoma,Vazirmatn,system-ui;background:#071018;color:#e6eef8;margin:0;padding:14px;}
.wrap{max-width:900px;margin:0 auto;}
h1{text-align:center;margin-bottom:12px;font-size:1.2rem;}
button{background:#22c1b6;color:#041014;border:0;padding:7px 12px;border-radius:8px;font-weight:700;cursor:pointer;margin-bottom:8px;}
table{width:100%;border-collapse:collapse;margin-top:8px;}
th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.04);text-align:center;font-size:0.95rem;}
th{color:#9fb7c9;}
.muted{opacity:.7;font-size:0.9rem;}
</style>
</head>
<body>
<div class="wrap">
<h1>ğŸ“Š Ù‚ÛŒÙ…Øª Ùˆ Ø¢Ù…Ø§Ø± Ø¢Ù†â€ŒÚ†ÛŒÙ†</h1>
<button id="refreshBtn">Ø±ÙØ±Ø´ / Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
<button id="downloadBtn">Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
<table>
<thead><tr><th>Ù†Ù…Ø§Ø¯</th><th>Ù‚ÛŒÙ…Øª (USD)</th><th>Ù…Ø§Ø±Ú©Øªâ€ŒÚ©Ù¾</th><th>Ø­Ø¬Ù… Û²Û´h</th><th>ØªØºÛŒÛŒØ± Û²Û´h</th></tr></thead>
<tbody id="tableBody"><tr><td colspan="5" class="muted">Ù…Ù†ØªØ¸Ø± Ø±ÙØ±Ø´...</td></tr></tbody>
</table>

<div style="margin-top:12px;">
<h3>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù†â€ŒÚ†ÛŒÙ†</h3>
<div id="onchainContent" class="muted">Ø¨Ø¹Ø¯ Ø§Ø² Ø±ÙØ±Ø´ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
</div>
</div>

<script>
let latestData = null;
let history = []; // Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡

async function loadData(){
  const tBody = document.getElementById('tableBody');
  const onchainDiv = document.getElementById('onchainContent');
  tBody.innerHTML='<tr><td colspan="5" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>';
  onchainDiv.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø¢Ù†â€ŒÚ†ÛŒÙ†...';
  try{
    const res = await fetch('/api/data');
    const js = await res.json();
    latestData = js; 

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ timestamp
    const timestamp = new Date().toISOString();
    js.coins.forEach(c=>{
      const oc = js.onchain.find(o=>o.id===c.id);
      const stats = oc && oc.stats ? oc.stats : {};
      history.push({
        timestamp,
        id: c.id,
        price: c.price || '',
        market_cap: c.market_cap || '',
        volume: c.volume || '',
        change24: c.change24 || '',
        unique_addresses: stats.unique_addresses || '',
        active_addresses: stats.active_addresses || '',
        large_transactions: stats.large_transactions || '',
        new_addresses: stats.new_addresses || ''
      });
    });

    // Ø¬Ø¯ÙˆÙ„ Ù‚ÛŒÙ…Øª
    let rows='';
    js.coins.forEach(c=>{
      rows+=`<tr>
        <td>${c.id}${c.error?'<span style="color:red"> (Ø®Ø·Ø§)</span>':''}</td>
        <td>${c.price!==null?c.price.toFixed(8):'â€”'}</td>
        <td>${c.market_cap!==null?c.market_cap.toLocaleString():'â€”'}</td>
        <td>${c.volume!==null?c.volume.toLocaleString():'â€”'}</td>
        <td>${c.change24!==null?c.change24.toFixed(2)+'%':'â€”'}</td>
      </tr>`;
    });
    tBody.innerHTML = rows;

    // Ø¢Ù†â€ŒÚ†ÛŒÙ†
    let ocHtml='';
    js.onchain.forEach(o=>{
      if(o.error) ocHtml+=`<div>${o.id}: Ø®Ø·Ø§</div>`;
      else if(o.stats){
        let parts=[];
        for(const k in o.stats){ parts.push(`${k}: ${o.stats[k]}`);}
        ocHtml+=`<div><strong>${o.id}:</strong> ${parts.join(' | ')}</div>`;
      } else {ocHtml+=`<div>${o.id}: Ø¯Ø§Ø¯Ù‡ Ù†Ø¯Ø§Ø±Ø¯</div>`;}
    });
    onchainDiv.innerHTML=ocHtml;

  }catch(e){
    tBody.innerHTML='<tr><td colspan="5" class="muted">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</td></tr>';
    onchainDiv.textContent='Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø¢Ù†â€ŒÚ†ÛŒÙ†';
    console.error(e);
  }
}

// Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV ØªØ§Ø±ÛŒØ®Ú†Ù‡
function downloadCSV(){
  if(history.length===0){ alert('Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯'); return; }
  let csv='Ø²Ù…Ø§Ù†,Ù†Ù…Ø§Ø¯,Ù‚ÛŒÙ…Øª,Ù…Ø§Ø±Ú©Øªâ€ŒÚ©Ù¾,Ø­Ø¬Ù… Û²Û´h,ØªØºÛŒÛŒØ± Û²Û´h,Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§,Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„,ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯,Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯\n';
  history.forEach(r=>{
    csv+=`${r.timestamp},${r.id},${r.price},${r.market_cap},${r.volume},${r.change24},${r.unique_addresses},${r.active_addresses},${r.large_transactions},${r.new_addresses}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'crypto_dashboard_history.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

document.getElementById('refreshBtn').addEventListener('click',loadData);
document.getElementById('downloadBtn').addEventListener('click',downloadCSV);
</script>
</body>
</html>